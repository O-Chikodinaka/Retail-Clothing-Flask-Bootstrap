{% extends "base.html" %}
{% block title %}Your Shopping Basket{% endblock %}

{% block content %}
<h1 class="mb-4">Your Shopping Basket</h1>

{% if cart_data %}
<div class="row">
    <!-- Left Column: Cart Items Table -->
    <div class="col-lg-8">
        <div class="card shadow-sm mb-4">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th scope="col" class="text-start">Product</th>
                                <th scope="col" class="text-center" style="width: 150px;">Quantity</th>
                                <th scope="col" class="text-end">Price</th>
                                <th scope="col" class="text-end">Total</th>
                                <th scope="col" class="text-center">Remove</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- prettier-ignore -->
                            {% for data in cart_data %}
                            {% set item = data.item %}
                            {% set product = data.product %}
                            <tr>
                                <!-- Product Info -->
                                <td class="py-3 text-start">
                                    <div class="d-flex align-items-center">
                                        <img src="{{ product.image_url or url_for('static', filename='images/default_product.jpg') }}" 
                                             alt="{{ product.name }}" 
                                             class="rounded me-3" 
                                             style="width: 60px; height: 60px; object-fit: cover;">
                                        <div>
                                            <a href="{{ url_for('main.product_detail', prod_id=product.prod_id) }}" class="fw-bold text-decoration-none text-dark">{{ product.name }}</a>
                                            <p class="text-muted small mb-0">{{ product.category|capitalize }}</p>
                                        </div>
                                    </div>
                                </td>

                                <!-- Quantity Update Form -->
                                <td class="text-center">
                                    <form method="POST" action="{{ url_for('cart.update_cart_item_quantity', cart_item_id=item.cart_item_id) }}" class="d-flex justify-content-center">
                                        <input type="number" 
                                               name="qty" 
                                               value="{{ item.qty }}" 
                                               min="1" 
                                               max="{{ product.stock_level }}"
                                               class="form-control form-control-sm text-center" 
                                               style="width: 70px;" 
                                               onchange="this.form.submit()">
                                    </form>
                                </td>
                                
                                <!-- Price -->
                                <td class="text-end">£{{ product.price|round(2) }}</td>
                                
                                <!-- Item Total -->
                                <td class="text-end fw-bold">£{{ data.item_total|round(2) }}</td>

                                <!-- Remove Button -->
                                <td class="text-center">
                                    <form method="POST" action="{{ url_for('cart.remove_from_cart', cart_item_id=item.cart_item_id) }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger" title="Remove Item">
                                            <i class="bi bi-trash-fill"></i> &times;
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="text-end">
            <a href="{{ url_for('main.product_list') }}" class="btn btn-outline-primary">Continue Shopping</a>
        </div>
    </div>

    <!-- Right Column: Summary Card -->
    <div class="col-lg-4">
        <div class="card shadow-sm bg-light">
            <div class="card-header bg-primary text-white fw-bold">
                Order Summary
            </div>
            <div class="card-body">
                <ul class="list-group list-group-flush">
                    <!-- prettier-ignore -->
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                        Subtotal ({{ cart_data|length }} item{% if cart_data|length != 1 %}s{% endif %})
                        <span>£{{ subtotal|round(2) }}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                        Shipping
                        <span>
                            {% if shipping > 0 %}
                                £{{ shipping|round(2) }}
                            {% else %}
                                Free
                            {% endif %}
                        </span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between align-items-center fw-bold fs-5 bg-light">
                        Grand Total
                        <span class="text-primary">£{{ grand_total|round(2) }}</span>
                    </li>
                </ul>
                
                <hr>

                <form method="POST" action="{{ url_for('cart.checkout') }}">
                    <!-- Payment Method Selection -->
                    <div class="mb-3">
                        <label for="payment_method" class="form-label fw-bold">Payment Method</label>
                        <select class="form-select" id="payment_method" name="payment_method" required>
                            <option value="">Select Payment Method</option>
                            <option value="Wallet">Wallet (£{{ current_user.wallet_balance|round(2) }})</option>
                            <option value="Credit Card">Credit Card</option>
                            <option value="Debit Card">Debit Card</option>
                            <option value="PayPal">PayPal</option>
                            <option value="Bank Transfer">Bank Transfer</option>
                        </select>
                        <div class="form-text">For demo purposes only - no real payments processed</div>
                    </div>
                    
                    <button type="submit" class="btn btn-success btn-lg w-100 shadow mt-3">
                        Proceed to Checkout
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

{% else %}
<div class="alert alert-info text-center py-5">
    <h4 class="alert-heading">Your Basket is Empty!</h4>
    <p>It looks like you haven't added anything to your basket yet.</p>
    <a href="{{ url_for('main.product_list') }}" class="btn btn-primary mt-2">Start Shopping Now</a>
</div>
{% endif %}
{% endblock %}
